name: Nightly

on:
  schedule:
    - cron: "8 0 * * *"

  workflow_dispatch:

jobs:
  auto_checks:
    runs-on: ubuntu-latest
    container:
      image: python:3.10

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install Latest Memfault CLI
        run: |
          pip install --upgrade memfault-cli
          memfault --version

      - name: Verify Memfault CLI Help
        run: |
          printf '```text
          $ memfault --help
          %s
          ```
          ' "$(CI=1 memfault --help)" > help.txt

          diff -u src/pages/_partials/_memfault-cli-help.mdx help.txt

      - name: Verify Zephyr instructions use latest Memfault SDK release
        run: |
          # get latest SDK tag from github
          SDK_TAG=$(curl -s https://api.github.com/repos/memfault/memfault-firmware-sdk/releases/latest | grep tag_name | cut -d '"' -f 4)
          printf '```yaml
          manifest:
            remotes:
              # Add the Memfault GitHub repo
              - name: memfault
                url-base: https://github.com/memfault

            projects:
              # The Memfault SDK
              - name: memfault-firmware-sdk
                path: modules/lib/memfault-firmware-sdk
                revision: %s
                remote: memfault
          ```
          ' ${SDK_TAG} > zephyr.west

          diff -u src/pages/_partials/_zephyr-manifest.mdx zephyr.west

  run-if-failed:
    runs-on: ubuntu-latest
    needs: [auto_checks]

    # run if any job failed, only on the scheduled runs
    if: |
      always() && contains(needs.*.result, 'failure') && github.event_name == 'schedule'
    steps:
      - name: Slack Notification
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_COLOR: failure
          SLACK_USERNAME: docs-nightly
          SLACK_ICON_EMOJI: ":boom:"
          MSG_MINIMAL: "actions url"
          SLACK_MESSAGE:
            "Auto checks failed for memfault/memfault-docs!"
